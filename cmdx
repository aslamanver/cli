#!/bin/bash

CONFIG_FILE="$HOME/.cmdx"

# Ensure the config file exists
touch "$CONFIG_FILE"
chmod 600 "$CONFIG_FILE"

RESERVED=("--add" "--remove" "--list")

# No argument given
if [ $# -eq 0 ]; then
  echo "Usage:"
  echo "  cmdx --add <name> <command>     Add or update a shortcut"
  echo "  cmdx --remove <name>            Remove a shortcut"
  echo "  cmdx --list                     List all shortcuts"
  echo "  cmdx <name>                     Run a saved shortcut"
  exit 0
fi

case "$1" in
  --add)
    NAME="$2"
    shift 2
    if [ -z "$NAME" ]; then
      echo "❌ Missing shortcut name"
      exit 1
    fi

    for word in "${RESERVED[@]}"; do
      if [ "$NAME" == "$word" ]; then
        echo "❌ Cannot use reserved command name: $NAME"
        exit 1
      fi
    done

    CMD="$*"

    if grep -q "^$NAME=" "$CONFIG_FILE"; then
      if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' "/^$NAME=/d" "$CONFIG_FILE"
      else
        sed -i "/^$NAME=/d" "$CONFIG_FILE"
      fi
    fi

    echo "$NAME=\"$CMD\"" | sed 's/[[:space:]]*$//' >> "$CONFIG_FILE"
    echo "✅ Added/Updated shortcut: $NAME"
    ;;

  --remove)
    NAME="$2"
    if [ -z "$NAME" ]; then
      echo "❌ Missing shortcut name"
      exit 1
    fi

    if grep -q "^$NAME=" "$CONFIG_FILE"; then
      if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' "/^$NAME=/d" "$CONFIG_FILE"
      else
        sed -i "/^$NAME=/d" "$CONFIG_FILE"
      fi
      echo "✅ Removed shortcut: $NAME"
    else
      echo "❌ Shortcut not found: $NAME"
      exit 1
    fi
    ;;

  --list)
    sort "$CONFIG_FILE"
    ;;

  *)
    # Run saved shortcut
    if grep -q "^$1=" "$CONFIG_FILE"; then
      CMD=$(grep -m1 -E "^${1}=" "$CONFIG_FILE" | cut -d'=' -f2- | sed -E 's/^"//; s/"$//')
      echo -e "> $CMD"
      read -n 1 -s -r -p "> Press any key to continue..."
      echo
      eval "$CMD"
    else
      echo "❌ No such command: $1"
      exit 1
    fi
    ;;
esac
