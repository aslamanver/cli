#!/bin/bash

# ==========================================================
# CLI Installer Script
# Installs all CLI tools from your GitHub repo
# and makes them globally accessible.
#
# Usage:
#   bash <(curl -s https://aslamanver.github.io/cli/install)
# ==========================================================

set -e

REPO_URL="https://github.com/aslamanver/cli"
INSTALL_DIR="$HOME/.cli"

# ----------------------------------------------------------
# ğŸ§© Check for required dependencies
# ----------------------------------------------------------
for cmd in curl tar; do
  if ! command -v $cmd >/dev/null 2>&1; then
    echo "âŒ '$cmd' is required but not installed."
    exit 1
  fi
done

echo "ğŸš€ Installing CLI tools from $REPO_URL ..."

# ----------------------------------------------------------
# ğŸ“ Create install directory
# ----------------------------------------------------------
mkdir -p "$INSTALL_DIR"

# ----------------------------------------------------------
# â¬‡ï¸  Download all files together as tar.gz from main branch
# ----------------------------------------------------------
echo "â¬‡ï¸  Downloading repository archive..."
curl -fsSL "$REPO_URL/archive/refs/heads/main.tar.gz" -o /tmp/cli.tar.gz

# ----------------------------------------------------------
# ğŸ“¦ Extract and install
# ----------------------------------------------------------
echo "ğŸ“¦ Extracting all files..."
tar -xzf /tmp/cli.tar.gz -C /tmp
cp -r /tmp/cli-main/* "$INSTALL_DIR/"

# ----------------------------------------------------------
# ğŸ”§ Make scripts executable
# ----------------------------------------------------------
chmod -R +x "$INSTALL_DIR"

# ----------------------------------------------------------
# ğŸ§  Detect shell config file
# ----------------------------------------------------------
SHELL_RC=""
if [ -n "$ZSH_VERSION" ]; then
    SHELL_RC="$HOME/.zshrc"
elif [ -n "$BASH_VERSION" ]; then
    SHELL_RC="$HOME/.bashrc"
else
    SHELL_RC="$HOME/.profile"
fi

# ----------------------------------------------------------
# ğŸ› ï¸ Add to PATH if not already included
# ----------------------------------------------------------
if ! grep -q "$INSTALL_DIR" "$SHELL_RC"; then
    echo "export PATH=\"\$PATH:$INSTALL_DIR\"" >> "$SHELL_RC"
    echo "âœ… Added $INSTALL_DIR to PATH in $SHELL_RC"
else
    echo "â„¹ï¸  PATH already includes $INSTALL_DIR"
fi

# ----------------------------------------------------------
# ğŸ§¹ Cleanup
# ----------------------------------------------------------
rm -rf /tmp/cli.tar.gz /tmp/cli-main

# ----------------------------------------------------------
# ğŸ‰ Done!
# ----------------------------------------------------------
echo "âœ… Installation complete!"
echo "ğŸ“‚ Installed directory: $INSTALL_DIR"

# ----------------------------------------------------------
# ğŸ”„ Source the shell config to apply changes immediately
# ----------------------------------------------------------
echo "âœ… Added $INSTALL_DIR to PATH in $SHELL_RC"
echo "ğŸ” Please run: source $SHELL_RC"
echo "   or open a new terminal for changes to take effect."
