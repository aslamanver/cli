#!/bin/bash

# ==========================================================
# CLI Installer Script
# Installs all CLI tools from your GitHub repo
# and makes them globally accessible.
#
# Usage:
#   bash <(curl -s https://aslamanver.github.io/cli/install)
# ==========================================================

set -e

REPO_URL="https://github.com/aslamanver/cli"
INSTALL_DIR="$HOME/.cli"

echo "üöÄ Installing CLI tools from $REPO_URL ..."

# ----------------------------------------------------------
# üß© Check for required dependencies
# ----------------------------------------------------------
for cmd in curl tar; do
  if ! command -v $cmd >/dev/null 2>&1; then
    echo "‚ùå '$cmd' is required but not installed."
    exit 1
  fi
done

# ----------------------------------------------------------
# üìÅ Create install directory
# ----------------------------------------------------------
mkdir -p "$INSTALL_DIR"

# ----------------------------------------------------------
# ‚¨áÔ∏è  Download all files together as tar.gz from main branch
# ----------------------------------------------------------
echo "‚¨áÔ∏è  Downloading repository archive..."
curl -fsSL "$REPO_URL/archive/refs/heads/main.tar.gz" -o /tmp/cli.tar.gz

# ----------------------------------------------------------
# üì¶ Extract and install
# ----------------------------------------------------------
echo "üì¶ Extracting all files..."
tar -xzf /tmp/cli.tar.gz -C /tmp
cp -r /tmp/cli-main/* "$INSTALL_DIR/"

# ----------------------------------------------------------
# üîß Make scripts executable
# ----------------------------------------------------------
chmod -R +x "$INSTALL_DIR"

# ----------------------------------------------------------
# üß† Detect shell config file
# ----------------------------------------------------------
SHELL_RC=""
if [ -n "$ZSH_VERSION" ]; then
    SHELL_RC="$HOME/.zshrc"
elif [ -n "$BASH_VERSION" ]; then
    SHELL_RC="$HOME/.bashrc"
else
    SHELL_RC="$HOME/.profile"
fi

# ----------------------------------------------------------
# üõ†Ô∏è Add to PATH if not already included
# ----------------------------------------------------------
if ! grep -q "$INSTALL_DIR" "$SHELL_RC"; then
    echo "export PATH=\"\$PATH:$INSTALL_DIR\"" >> "$SHELL_RC"
    echo "‚úÖ Added $INSTALL_DIR to PATH in $SHELL_RC"
else
    echo "‚ÑπÔ∏è  PATH already includes $INSTALL_DIR"
fi

# ----------------------------------------------------------
# üßπ Cleanup
# ----------------------------------------------------------
rm -rf /tmp/cli.tar.gz /tmp/cli-main

# ----------------------------------------------------------
# üéâ Done!
# ----------------------------------------------------------
echo "‚úÖ Installation complete!"
echo "üìÇ Installed directory: $INSTALL_DIR"

# ----------------------------------------------------------
# üîÑ Source the shell config to apply changes immediately
# ----------------------------------------------------------
source $SHELL_RC
